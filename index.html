<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tracker ‚Äî –ì–∞–Ω—Ç (–º—è–≥–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --accent:#4666ff; --muted:#6b6f76;
    --ok:#2db47e; --danger:#ff6b6b; --shadow: 0 8px 24px rgba(20,30,70,0.06);
    --prio-high:#ffdddd; --prio-mid:#fff6e6; --prio-low:#eefaf0;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);font-family:Inter, Roboto, Arial, sans-serif;color:#222;margin:0;padding:28px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:1180px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  #projectTitle{flex:1;padding:10px;border-radius:10px;border:1px solid #e8eefb;font-size:18px}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid #eef2fb;box-shadow:var(--shadow);margin-bottom:14px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"], input[type="date"], input[type="number"], select{
    padding:8px;border-radius:8px;border:1px solid #e6ebf8;background:white;font-size:14px;
  }
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(70,102,255,0.12)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #f0f3fa;vertical-align:middle}
  th{background:#fbfcff;color:var(--muted);font-weight:700;text-align:left}
  .id{width:62px;font-weight:700;color:#334}
  .center{text-align:center}
  .nowrap{white-space:nowrap}
  .small{font-size:13px;color:var(--muted)}
  .prio-chip{display:inline-flex;gap:8px;align-items:center;padding:6px 8px;border-radius:999px;font-weight:700}
  .prio-high{background:var(--prio-high);color:#c0392b}
  .prio-mid{background:var(--prio-mid);color:#b36b00}
  .prio-low{background:var(--prio-low);color:#0a7a4a}

  .gantt-wrap{overflow:auto;padding:8px}
  .gantt-canvas{background:white;border-radius:10px;border:1px solid #eef2fb;padding:10px}
  .legend{display:flex;gap:8px;align-items:center;margin-top:8px}
  .legend .item{display:flex;gap:6px;align-items:center;font-size:13px;color:var(--muted)}
  .bar-rect{width:18px;height:10px;border-radius:4px;display:inline-block}
  .actions{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <input id="projectTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" />
      <div class="actions">
        <button class="ghost" onclick="downloadCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button class="ghost" onclick="importCSVPrompt()">–ò–º–ø–æ—Ä—Ç CSV</button>
        <button class="ghost" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </header>

    <div class="card controls">
      <input id="taskName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="min-width:180px"/>
      <input id="taskStart" type="date" />
      <input id="taskEnd" type="date" />
      <input id="taskDuration" type="number" min="1" placeholder="–î–ª–∏—Ç. –¥–Ω." style="width:90px"/>
      <input id="taskDepends" type="text" placeholder="Depends (ID –∏–ª–∏ –∏–º—è)" style="width:140px"/>
      <select id="taskPriority">
        <option value="–í—ã—Å–æ–∫–∏–π">üî• –í—ã—Å–æ–∫–∏–π</option>
        <option value="–°—Ä–µ–¥–Ω–∏–π" selected>‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π</option>
        <option value="–ù–∏–∑–∫–∏–π">‚úÖ –ù–∏–∑–∫–∏–π</option>
      </select>
      <input id="taskOwner" type="text" placeholder="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" style="width:130px"/>
      <select id="taskStatus">
        <option>–ù–µ –Ω–∞—á–∞—Ç–æ</option><option>–í —Ä–∞–±–æ—Ç–µ</option><option>–û–∂–∏–¥–∞–Ω–∏–µ</option><option>–ì–æ—Ç–æ–≤–æ</option><option>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</option>
      </select>
      <button onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="grid">
      <div class="card">
        <table id="tasksTable" role="grid">
          <thead>
            <tr>
              <th class="id">ID</th>
              <th>–ó–∞–¥–∞—á–∞</th>
              <th>Start</th>
              <th>End</th>
              <th>–î–ª–∏—Ç. (–¥–Ω)</th>
              <th>Depends</th>
              <th>Override</th>
              <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
              <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th class="center">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px" class="small muted">Soft-dependencies: –µ—Å–ª–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∑–∞–¥–∞–Ω–∞ –∏ Override –≤—ã–∫–ª—é—á–µ–Ω ‚Äî Start –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ä–∞–≤–µ–Ω End –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞. –ü—Ä–∏ —Ä—É—á–Ω–æ–π –ø—Ä–∞–≤–∫–µ Start/End Override –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</strong></div>
            <div class="small muted">–ú–∞—Å—à—Ç–∞–± –ø–æ –¥–Ω—è–º. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          </div>

          <div class="gantt-wrap" style="margin-top:10px">
            <div class="gantt-canvas">
              <canvas id="ganttCanvas" width="820" height="420" style="width:100%;height:420px;display:block"></canvas>
            </div>
            <div class="legend">
              <div class="item"><span class="bar-rect" style="background:#4666ff"></span> –ê–∫—Ç–∏–≤–Ω–∞—è</div>
              <div class="item"><span class="bar-rect" style="background:#2db47e"></span> –ì–æ—Ç–æ–≤–æ</div>
              <div class="item"><span class="bar-rect" style="background:#ff6b6b"></span> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="card small muted">ID –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (A1, A2‚Ä¶). –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —É–¥–æ–±–Ω–µ–µ —É–∫–∞–∑—ã–≤–∞—Ç—å ID.</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Date helpers (timezone-safe)
   We treat dates as yyyy-mm-dd strings and do arithmetic in UTC midnight.
   ========================= */
function parseYMD(s){
  // returns Date (UTC midnight) or null
  if(!s) return null;
  // expect exactly YYYY-MM-DD
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if(!m) return null;
  const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
  return new Date(Date.UTC(y, mo-1, d));
}
function fmtYMD(dt){
  if(!dt) return "";
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth() + 1).padStart(2,"0");
  const d = String(dt.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function addDaysUTC(dt, n){
  const copy = new Date(dt.getTime());
  copy.setUTCDate(copy.getUTCDate() + n);
  return copy;
}
function daysBetweenUTC(a,b){
  // a,b Dates (UTC)
  const diff = Math.round((b.getTime() - a.getTime()) / (24*3600*1000));
  return diff;
}

/* =========================
   Data model + storage
   ========================= */
const STORAGE_KEY = "tracker.softdeps.v1";
let tasks = []; // {id,name,start,end,duration,depends,override,priority,owner,status}
const DEFAULT_DAYS = 3;

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ tasks = JSON.parse(raw); }
    catch(e){ tasks = []; }
  }
  if(!tasks || tasks.length === 0){
    // initial sample
    const today = fmtYMD(new Date(Date.now()));
    tasks = [
      {id:"A1", name:"–û–±–º–µ—Ä", start: today, end: fmtYMD(addDaysUTC(parseYMD(today), 2)), duration:3, depends:"", override:false, priority:"–í—ã—Å–æ–∫–∏–π", owner:"–ê–ª–∏—Å–∞", status:"–í —Ä–∞–±–æ—Ç–µ"},
      {id:"A2", name:"–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏", start:"", end:"", duration:5, depends:"A1", override:false, priority:"–°—Ä–µ–¥–Ω–∏–π", owner:"–°–∞—à–∞", status:"–ù–µ –Ω–∞—á–∞—Ç–æ"},
      {id:"A3", name:"–ß–µ—Ä—Ç–µ–∂–∏", start:"", end:"", duration:4, depends:"A2", override:false, priority:"–ù–∏–∑–∫–∏–π", owner:"–û–ª—è", status:"–ù–µ –Ω–∞—á–∞—Ç–æ"}
    ];
    save();
  }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
  render();
}

/* =========================
   Dependency resolution (soft)
   - If task.depends references predecessor (by id or exact name) and override==false:
       start(task) := end(pred)  (same day)
       end(task) := start + duration - 1   (unless user manually set a different end previously)
   - If start set but no end -> end = start + duration -1
   - If user manually edits start or end -> override = true for that task
   Implementation:
     - iterative passes until stable (max passes)
     - we preserve duration per task (tasks[i].duration)
   ========================= */
function resolveDependencies(){
  const lookup = {};
  tasks.forEach(t => { lookup[t.id] = t; lookup[t.name] = t; });

  // ensure duration numbers
  tasks.forEach(t => {
    t.duration = Number(t.duration) || DEFAULT_DAYS;
  });

  let changed = true;
  let passes = 0;
  const maxPasses = tasks.length + 8;

  while(changed && passes < maxPasses){
    changed = false;
    passes++;
    for(const t of tasks){
      // compute startDate and endDate as Date objects
      let s = parseYMD(t.start);
      let e = parseYMD(t.end);

      // if depends & predecessor exists & not override
      if(t.depends && !t.override){
        const pred = lookup[t.depends];
        if(pred && pred.end){
          const predEnd = parseYMD(pred.end);
          if(predEnd){
            const desiredStart = fmtYMD(predEnd); // exactly same day as pred.end
            if(t.start !== desiredStart){
              t.start = desiredStart;
              s = parseYMD(t.start);
              changed = true;
            }
            // set end based on duration unless user set a custom end that is later than computed
            const desiredEnd = fmtYMD(addDaysUTC(s, t.duration - 1));
            if(!t.end || parseYMD(t.end) < s || t._lastAutoEnd === t.end){
              if(t.end !== desiredEnd){
                t.end = desiredEnd;
                changed = true;
              }
            }
            t._lastAutoEnd = t.end;
            continue; // handled
          }
        }
      }

      // if no depends or override: if start exists and no valid end -> set end based on duration
      if(t.start){
        s = parseYMD(t.start);
        if(!s) continue;
        const desiredEnd = fmtYMD(addDaysUTC(s, t.duration - 1));
        if(!t.end || parseYMD(t.end) < s || t._lastAutoEnd === t.end){
          if(t.end !== desiredEnd){
            t.end = desiredEnd;
            changed = true;
          }
        }
        t._lastAutoEnd = t.end;
      } else {
        // no start: if end exists and no start -> try to derive start based on duration
        if(t.end){
          e = parseYMD(t.end);
          if(e){
            const desiredStart = fmtYMD(addDaysUTC(e, - (t.duration - 1)));
            if(t.start !== desiredStart){
              t.start = desiredStart;
              changed = true;
            }
            t._lastAutoEnd = t.end;
          }
        }
      }
    } // end for
  } // end while

  // normalize strings
  tasks.forEach(t => {
    t.start = parseYMD(t.start) ? fmtYMD(parseYMD(t.start)) : "";
    t.end = parseYMD(t.end) ? fmtYMD(parseYMD(t.end)) : "";
    t.duration = Number(t.duration) || DEFAULT_DAYS;
  });
}

/* =========================
   UI rendering & bindings
   ========================= */
function render(){
  resolveDependencies();
  const tbody = document.querySelector("#tasksTable tbody");
  tbody.innerHTML = "";
  for(const t of tasks){
    const tr = document.createElement("tr");

    // id
    const tdId = document.createElement("td"); tdId.className="id"; tdId.textContent = t.id; tr.appendChild(tdId);

    // name
    const tdName = document.createElement("td");
    const inName = document.createElement("input"); inName.type="text"; inName.value = t.name || "";
    inName.onchange = () => { t.name = inName.value.trim(); save(); };
    tdName.appendChild(inName); tr.appendChild(tdName);

    // start
    const tdStart = document.createElement("td");
    const inStart = document.createElement("input"); inStart.type="date"; inStart.value = t.start || "";
    inStart.onchange = () => {
      // when user edits start manually -> set override = true
      t.start = inStart.value || "";
      t.override = true;
      // recalc duration cache if end exists
      if(t.start && t.end){
        const s = parseYMD(t.start), e = parseYMD(t.end);
        if(s && e) t.duration = Math.max(1, daysBetweenUTC(s,e) + 1);
      }
      save();
    };
    tdStart.appendChild(inStart); tr.appendChild(tdStart);

    // end
    const tdEnd = document.createElement("td");
    const inEnd = document.createElement("input"); inEnd.type="date"; inEnd.value = t.end || "";
    inEnd.onchange = () => {
      t.end = inEnd.value || "";
      t.override = true; // manual change should enable override
      if(t.start && t.end){
        const s = parseYMD(t.start), e = parseYMD(t.end);
        if(s && e) t.duration = Math.max(1, daysBetweenUTC(s,e) + 1);
      }
      save();
    };
    tdEnd.appendChild(inEnd); tr.appendChild(tdEnd);

    // duration
    const tdDur = document.createElement("td");
    const inDur = document.createElement("input"); inDur.type="number"; inDur.min=1; inDur.value = t.duration || DEFAULT_DAYS; inDur.style.width="80px";
    inDur.onchange = () => {
      const v = Math.max(1, Number(inDur.value) || DEFAULT_DAYS);
      t.duration = v;
      // if start exists and no manual override of end, update end to start+duration-1
      if(t.start && !t.override){
        const s = parseYMD(t.start);
        t.end = fmtYMD(addDaysUTC(s, t.duration - 1));
      }
      save();
    };
    tdDur.appendChild(inDur); tr.appendChild(tdDur);

    // depends
    const tdDep = document.createElement("td");
    const inDep = document.createElement("input"); inDep.type="text"; inDep.value = t.depends || "";
    inDep.placeholder = "A1 –∏–ª–∏ —Ç–æ—á–Ω–æ–µ –∏–º—è";
    inDep.onchange = () => { t.depends = inDep.value.trim(); save(); };
    tdDep.appendChild(inDep); tr.appendChild(tdDep);

    // override
    const tdOv = document.createElement("td"); tdOv.className="center";
    const chk = document.createElement("input"); chk.type="checkbox"; chk.checked = !!t.override;
    chk.onchange = () => { t.override = chk.checked; save(); };
    tdOv.appendChild(chk); tr.appendChild(tdOv);

    // priority
    const tdPr = document.createElement("td");
    const selPr = document.createElement("select");
    [["–í—ã—Å–æ–∫–∏–π","üî• –í—ã—Å–æ–∫–∏–π"],["–°—Ä–µ–¥–Ω–∏–π","‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π"],["–ù–∏–∑–∫–∏–π","‚úÖ –ù–∏–∑–∫–∏–π"]].forEach(([val,lab])=>{
      const o = document.createElement("option"); o.value=val; o.textContent=lab;
      if(t.priority === val) o.selected = true;
      selPr.appendChild(o);
    });
    selPr.onchange = ()=> { t.priority = selPr.value; save(); };
    tdPr.appendChild(selPr); tr.appendChild(tdPr);

    // owner
    const tdOwn = document.createElement("td");
    const inOwn = document.createElement("input"); inOwn.type="text"; inOwn.value = t.owner || "";
    inOwn.onchange = ()=>{ t.owner = inOwn.value; save(); };
    tdOwn.appendChild(inOwn); tr.appendChild(tdOwn);

    // status
    const tdSt = document.createElement("td");
    const selSt = document.createElement("select");
    ["–ù–µ –Ω–∞—á–∞—Ç–æ","–í —Ä–∞–±–æ—Ç–µ","–û–∂–∏–¥–∞–Ω–∏–µ","–ì–æ—Ç–æ–≤–æ","–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ"].forEach(s=>{
      const o = document.createElement("option"); o.value = s; o.textContent = s;
      if(t.status === s) o.selected = true;
      selSt.appendChild(o);
    });
    selSt.onchange = ()=>{ t.status = selSt.value; save(); };
    tdSt.appendChild(selSt); tr.appendChild(tdSt);

    // actions
    const tdAct = document.createElement("td"); tdAct.className="center";
    const btnUp = document.createElement("button"); btnUp.className="ghost"; btnUp.style.padding="6px 8px"; btnUp.textContent="‚Üë";
    btnUp.onclick = ()=>{ moveTask(t.id, -1); };
    const btnDown = document.createElement("button"); btnDown.className="ghost"; btnDown.style.padding="6px 8px"; btnDown.textContent="‚Üì";
    btnDown.onclick = ()=>{ moveTask(t.id, 1); };
    const btnDel = document.createElement("button"); btnDel.style.marginLeft="6px"; btnDel.textContent="–£–¥–∞–ª–∏—Ç—å";
    btnDel.onclick = ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É '+t.id+'?')){ removeTask(t.id); } };
    tdAct.appendChild(btnUp); tdAct.appendChild(btnDown); tdAct.appendChild(btnDel);
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  }

  // project title persist
  const storedTitle = localStorage.getItem("project.title");
  if(storedTitle) document.getElementById("projectTitle").value = storedTitle;
  drawGantt();
}

/* CRUD helpers */
function genId(){ let n=1; while(tasks.some(t=> t.id === `A${n}`)) n++; return `A${n}`; }
function addTask(){
  const name = document.getElementById("taskName").value.trim();
  if(!name){ alert("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–µ–ª—å–∑—è –ø—É—Å—Ç—ã–º"); return; }
  const start = document.getElementById("taskStart").value || "";
  const end = document.getElementById("taskEnd").value || "";
  const dur = Number(document.getElementById("taskDuration").value) || DEFAULT_DAYS;
  const depends = document.getElementById("taskDepends").value.trim() || "";
  const priority = document.getElementById("taskPriority").value;
  const owner = document.getElementById("taskOwner").value.trim() || "";
  const status = document.getElementById("taskStatus").value;
  const obj = { id: genId(), name, start, end, duration: Math.max(1,dur), depends, override:false, priority, owner, status };
  // if start exists and no end -> compute end from duration
  if(obj.start && !obj.end){
    const s = parseYMD(obj.start);
    if(s) obj.end = fmtYMD(addDaysUTC(s, obj.duration - 1));
  }
  // if end exists and no start -> compute start from duration
  if(obj.end && !obj.start){
    const e = parseYMD(obj.end);
    if(e) obj.start = fmtYMD(addDaysUTC(e, - (obj.duration - 1)));
  }
  tasks.push(obj);
  // clear inputs
  document.getElementById("taskName").value = "";
  document.getElementById("taskStart").value = "";
  document.getElementById("taskEnd").value = "";
  document.getElementById("taskDuration").value = "";
  document.getElementById("taskDepends").value = "";
  document.getElementById("taskOwner").value = "";
  save();
}
function removeTask(id){
  tasks = tasks.filter(t=> t.id !== id);
  tasks.forEach(t=> { if(t.depends === id) t.depends = ""; });
  save();
}
function moveTask(id, dir){
  const idx = tasks.findIndex(t=> t.id === id);
  if(idx < 0) return;
  const to = idx + dir;
  if(to < 0 || to >= tasks.length) return;
  const tmp = tasks[to]; tasks[to] = tasks[idx]; tasks[idx] = tmp;
  save();
}
function clearAll(){ if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏?")){ tasks = []; save(); } }

/* CSV export/import */
function downloadCSV(){
  const hdr = ["ID","Name","Start","End","Duration","Depends","Override","Priority","Owner","Status"];
  const rows = tasks.map(t => [t.id, `"${(t.name||"").replace(/"/g,'""')}"`, t.start||"", t.end||"", String(t.duration||""), `"${(t.depends||"").replace(/"/g,'""')}"`, t.override? "1":"0", t.priority||"", t.owner||"", t.status||""]);
  const txt = [hdr.join(","), ...rows.map(r=>r.join(","))].join("\n");
  const blob = new Blob([txt], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "tasks.csv"; a.click(); URL.revokeObjectURL(url);
}
function importCSVPrompt(){
  const inp = document.createElement("input"); inp.type="file"; inp.accept=".csv";
  inp.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => { try{ parseCSV(ev.target.result); save(); } catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err); } };
    reader.readAsText(f,"utf-8");
  };
  inp.click();
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length < 2) throw "CSV –ø—É—Å—Ç –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω";
  const newTasks = [];
  for(let i=1;i<lines.length;i++){
    const cols = csvSplit(lines[i]);
    const t = {
      id: cols[0] || genId(),
      name: cols[1] ? cols[1].replace(/^"|"$/g,"").replace(/""/g,'"') : "",
      start: cols[2] || "",
      end: cols[3] || "",
      duration: Number(cols[4]) || DEFAULT_DAYS,
      depends: cols[5] ? cols[5].replace(/^"|"$/g,"").replace(/""/g,'"') : "",
      override: (cols[6]||"") === "1",
      priority: cols[7] || "–°—Ä–µ–¥–Ω–∏–π",
      owner: cols[8] || "",
      status: cols[9] || "–ù–µ –Ω–∞—á–∞—Ç–æ"
    };
    newTasks.push(t);
  }
  tasks = newTasks;
}
function csvSplit(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; continue; }
    if(ch === ',' && !q){ out.push(cur); cur=""; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* =========================
   GANTT drawing (UTC-safe)
   ========================= */
function drawGantt(){
  resolveDependencies();
  const canvas = document.getElementById("ganttCanvas");
  const ctx = canvas.getContext("2d");
  const containerWidth = canvas.clientWidth;
  canvas.width = Math.max(700, Math.floor(containerWidth));
  const width = canvas.width, height = canvas.height = 420;
  ctx.clearRect(0,0,width,height);

  const valid = tasks.filter(t => parseYMD(t.start) && parseYMD(t.end));
  if(valid.length === 0){
    ctx.fillStyle = "#666"; ctx.font = "14px Arial"; ctx.fillText("–ù–µ—Ç –∑–∞–¥–∞—á —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –¥–ª—è –ì–∞–Ω—Ç–∞", 20, 24); return;
  }

  // compute min/max
  let min = parseYMD(valid[0].start), max = parseYMD(valid[0].end);
  valid.forEach(t => {
    const s = parseYMD(t.start), e = parseYMD(t.end);
    if(s && s < min) min = s;
    if(e && e > max) max = e;
  });
  min = addDaysUTC(min, -1); max = addDaysUTC(max, 1);
  const totalDays = daysBetweenUTC(min, max) + 1;

  const leftPad = 150, rightPad = 30;
  const usable = width - leftPad - rightPad;
  const pxPerDay = Math.max(6, usable / Math.max(1, totalDays));

  // header background
  ctx.fillStyle = "#fafbff";
  ctx.fillRect(leftPad, 0, usable, 28);
  ctx.font = "12px Arial";
  for(let d=0; d<= totalDays; d++){
    const cur = addDaysUTC(min, d);
    const x = leftPad + Math.round(d * pxPerDay);
    ctx.strokeStyle = "#f0f2f7"; ctx.beginPath(); ctx.moveTo(x+0.5, 28); ctx.lineTo(x+0.5, height - 16); ctx.stroke();
    if(pxPerDay > 14 || d % Math.max(1, Math.ceil(3 / (pxPerDay/8))) === 0){
      ctx.fillStyle = "#333"; ctx.fillText(cur.toISOString().slice(0,10), x+2, 18);
    }
  }

  const rowH = 36;
  valid.forEach((t, idx) => {
    const y = 36 + idx * rowH;
    ctx.fillStyle = "#111"; ctx.font = "13px Arial"; ctx.fillText(`${t.id} ${t.name}`, 8, y + 14);
    ctx.fillStyle = idx % 2 === 0 ? "#fff" : "#fbfcff"; ctx.fillRect(leftPad, y, usable, rowH - 6);

    const s = parseYMD(t.start), e = parseYMD(t.end);
    if(!s || !e) return;
    const offset = daysBetweenUTC(min, s);
    const dur = daysBetweenUTC(s, e) + 1;
    const x = leftPad + Math.round(offset * pxPerDay);
    const w = Math.max(6, Math.round(dur * pxPerDay));

    let color = "#4666ff";
    if(t.status === "–ì–æ—Ç–æ–≤–æ") color = "#2db47e";
    if(t.status === "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ") color = "#ff6b6b";

    // rounded bar
    ctx.fillStyle = color;
    roundRect(ctx, x+2, y+6, w-4, 22, 6, true, false);

    ctx.fillStyle = "#fff"; ctx.font = "12px Arial";
    if(w > 80){
      ctx.fillText(t.name, x + 10, y + 20);
    } else {
      ctx.fillStyle = "#333"; ctx.fillText(t.name, x + w + 6, y + 18);
    }
    // draw start & end small
    ctx.fillStyle = "#666"; ctx.font = "11px Arial";
    ctx.fillText(fmtYMD(s), x, y + 36);
    ctx.fillText(fmtYMD(e), x + Math.max(6, w - 60), y + 36);
  });

  ctx.strokeStyle = "#e9eefb"; ctx.strokeRect(leftPad, 28, usable, valid.length * rowH);

  function roundRect(ctx,x,y,w,h,r,fill,stroke){
    if(w < 2*r) r = w/2; if(h < 2*r) r = h/2;
    ctx.beginPath();
    ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    if(fill) ctx.fill(); if(stroke) ctx.stroke();
  }
}

/* =========================
   Init and bindings
   ========================= */
document.getElementById("projectTitle").addEventListener("change", () => {
  localStorage.setItem("project.title", document.getElementById("projectTitle").value);
});

function boot(){
  const t = localStorage.getItem("project.title");
  if(t) document.getElementById("projectTitle").value = t;
  load();
  render();
  window.addEventListener("resize", () => { drawGantt(); });
  // expose for debugging
  window.tracker = { tasks, save, load, render, drawGantt, resolveDependencies };
}
boot();

</script>
</body>
</html>
