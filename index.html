<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Project Tracker ‚Äî –ì–∞–Ω—Ç —Å —É—á—ë—Ç–æ–º –≤—ã—Ö–æ–¥–Ω—ã—Ö –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–π</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --muted:#6d7280; --accent:#3f6ef8;
    --ok:#2db47e; --danger:#ff6b6b; --shadow:0 8px 24px rgba(30,40,80,0.06);
  }
  *{box-sizing:border-box}
  body{margin:0;padding:28px;background:var(--bg);font-family:Inter, Arial, sans-serif;color:#222;display:flex;justify-content:center}
  .wrap{width:100%;max-width:1200px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  #projectTitle{flex:1;padding:10px;border-radius:10px;border:1px solid #e8eefb;background:white;font-size:18px}
  .top{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid #eef2fb;box-shadow:var(--shadow);margin-bottom:14px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"], input[type="date"], input[type="number"], select{
    padding:8px;border-radius:8px;border:1px solid #e6ebf8;background:white;font-size:14px;
  }
  button{background:var(--accent);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(63,110,248,0.12)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
  @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #f0f3fa;vertical-align:middle}
  th{background:#fbfcff;color:var(--muted);font-weight:700;text-align:left}
  .id{width:62px;font-weight:700;color:#334}
  .center{text-align:center}
  .small{font-size:13px;color:var(--muted)}
  .prio-high{background:#fff0f0;color:#c0392b;padding:6px;border-radius:8px}
  .prio-mid{background:#fff9f0;color:#b36b00;padding:6px;border-radius:8px}
  .prio-low{background:#f0fff5;color:#0a7a4a;padding:6px;border-radius:8px}
  .gantt-wrap{overflow:auto;padding:8px}
  .gantt-canvas{background:white;border-radius:10px;border:1px solid #eef2fb;padding:10px}
  .legend{display:flex;gap:8px;align-items:center;margin-top:8px}
  .legend .item{display:flex;gap:6px;align-items:center;font-size:13px;color:var(--muted)}
  .bar-rect{width:18px;height:10px;border-radius:4px;display:inline-block}
  .actions{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  input[disabled], select[disabled]{background:#f6f8fb;color:#999}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <input id="projectTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" />
      <div class="actions">
        <button class="ghost" onclick="downloadCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        <button class="ghost" onclick="importCSVPrompt()">–ò–º–ø–æ—Ä—Ç CSV</button>
        <button class="ghost" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </header>

    <div class="card controls">
      <input id="taskName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="min-width:160px"/>
      <input id="taskStart" type="date" />
      <input id="taskEnd" type="date" />
      <input id="taskDuration" type="number" min="1" placeholder="–î–ª–∏—Ç. (–¥–Ω)" style="width:90px"/>
      <input id="taskDepends" type="text" placeholder="Depends (ID –∏–ª–∏ –∏–º—è)" style="width:140px"/>
      <select id="taskApproval">
        <option value="–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è">–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</option>
        <option value="–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ</option>
        <option value="–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</option>
        <option value="–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É">–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</option>
      </select>
      <input id="taskCorrection" type="number" style="width:90px" placeholder="–ö–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–Ω" />
      <select id="taskPriority">
        <option value="–í—ã—Å–æ–∫–∏–π">üî• –í—ã—Å–æ–∫–∏–π</option>
        <option value="–°—Ä–µ–¥–Ω–∏–π" selected>‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π</option>
        <option value="–ù–∏–∑–∫–∏–π">‚úÖ –ù–∏–∑–∫–∏–π</option>
      </select>
      <input id="taskOwner" type="text" placeholder="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" style="width:130px"/>
      <select id="taskStatus">
        <option>–ù–µ –Ω–∞—á–∞—Ç–æ</option><option>–í —Ä–∞–±–æ—Ç–µ</option><option>–û–∂–∏–¥–∞–Ω–∏–µ</option><option>–ì–æ—Ç–æ–≤–æ</option><option>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</option>
      </select>
      <button onclick="addTask()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>

    <div class="grid">
      <div class="card">
        <table id="tasksTable" role="grid">
          <thead>
            <tr>
              <th class="id">ID</th>
              <th>–ó–∞–¥–∞—á–∞</th>
              <th>Start</th>
              <th>End</th>
              <th>–î–ª–∏—Ç. (—Ä–∞–±. –¥–Ω)</th>
              <th>Depends</th>
              <th>Override</th>
              <th>Approval</th>
              <th>–ö–æ—Ä—Ä–µ–∫—Ü–∏—è</th>
              <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
              <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th class="center">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px" class="small muted">–ü—Ä–∏ —Å—Ç–∞—Ç—É—Å–µ ¬´–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ¬ª —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–æ (–∂–¥—ë–º —Ä–µ—à–µ–Ω–∏—è). –ü—Ä–∏ ¬´–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É¬ª –¥–æ—Å—Ç—É–ø–Ω–∞ –ö–æ—Ä—Ä–µ–∫—Ü–∏—è (¬± –¥–Ω) ‚Äî –∑–∞—Ç–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º—ã–µ —Å–º–µ—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤ —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è—Ö (–ü–Ω‚Äì–ü—Ç).</div>
      </div>

      <div>
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</strong></div>
            <div class="small muted">–ú–∞—Å—à—Ç–∞–± –ø–æ –¥–Ω—è–º. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          </div>

          <div class="gantt-wrap" style="margin-top:10px">
            <div class="gantt-canvas">
              <canvas id="ganttCanvas" width="820" height="460" style="width:100%;height:460px;display:block"></canvas>
            </div>
            <div class="legend">
              <div class="item"><span class="bar-rect" style="background:#4666ff"></span> –ê–∫—Ç–∏–≤–Ω–∞—è</div>
              <div class="item"><span class="bar-rect" style="background:#2db47e"></span> –ì–æ—Ç–æ–≤–æ</div>
              <div class="item"><span class="bar-rect" style="background:#ff6b6b"></span> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="card small muted">ID –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è (A1, A2‚Ä¶). –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Å–≤—è–∑–µ–π —É–¥–æ–±–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å ID.</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Date helpers (timezone-safe UTC)
   treat strings "YYYY-MM-DD"
   ========================= */
function parseYMD(s){
  if(!s) return null;
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
  if(!m) return null;
  const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
  return new Date(Date.UTC(y, mo, d));
}
function fmtYMD(dt){
  if(!dt) return "";
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth() + 1).padStart(2,"0");
  const d = String(dt.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}
function isWeekend(dt){
  const w = dt.getUTCDay();
  return w === 0 || w === 6; // Sun=0, Sat=6
}
function addDaysUTC(dt, n){
  const x = new Date(dt.getTime());
  x.setUTCDate(x.getUTCDate() + n);
  return x;
}
function addBusinessDays(dt, n){
  // n can be negative
  let cur = new Date(dt.getTime());
  const step = n >= 0 ? 1 : -1;
  let left = Math.abs(n);
  while(left > 0){
    cur = addDaysUTC(cur, step);
    if(!isWeekend(cur)) left--;
  }
  return cur;
}
function businessDaysBetweenInclusive(a,b){
  // returns count of business days from a to b inclusive
  if(!a || !b) return 0;
  const start = new Date(Date.UTC(a.getUTCFullYear(), a.getUTCMonth(), a.getUTCDate()));
  const end = new Date(Date.UTC(b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate()));
  if(end < start) return 0;
  let count = 0;
  let cur = new Date(start.getTime());
  while(cur <= end){
    if(!isWeekend(cur)) count++;
    cur = addDaysUTC(cur, 1);
  }
  return count;
}

/* =========================
   Data model & storage
   ========================= */
const STORAGE_KEY = "tracker.advanced.v1";
let tasks = []; // objects: {id,name,start,end,duration,depends,override,approval,correction,priority,owner,status}
const DEFAULT_DAYS = 3;

/* load/save */
function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw){
    try{ tasks = JSON.parse(raw); }
    catch(e){ tasks = []; }
  }
  if(!tasks || tasks.length === 0){
    // sample data
    const t0 = fmtYMD(new Date(Date.now()));
    tasks = [
      {id:"A1", name:"–û–±–º–µ—Ä", start:t0, end:fmtYMD(addBusinessDays(parseYMD(t0), 2)), duration:3, depends:"", override:false, approval:"–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è", correction:0, priority:"–°—Ä–µ–¥–Ω–∏–π", owner:"–ê–ª–∏—Å–∞", status:"–í —Ä–∞–±–æ—Ç–µ"},
      {id:"A2", name:"–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏", start:"", end:"", duration:5, depends:"A1", override:false, approval:"–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è", correction:0, priority:"–í—ã—Å–æ–∫–∏–π", owner:"–°–∞—à–∞", status:"–ù–µ –Ω–∞—á–∞—Ç–æ"},
      {id:"A3", name:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ ‚Ññ1", start:"", end:"", duration:3, depends:"A2", override:false, approval:"–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ", correction:0, priority:"–°—Ä–µ–¥–Ω–∏–π", owner:"–û–ª—è", status:"–ù–µ –Ω–∞—á–∞—Ç–æ"}
    ];
    save();
  }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
  render();
}

/* =========================
   Dependency & approval logic
   ========================= */
function resolveAll(){
  // build lookup by id and name
  const lookup = {};
  tasks.forEach(t => { lookup[t.id] = t; lookup[t.name] = t; });

  // normalize duration numbers
  tasks.forEach(t => { t.duration = Math.max(1, Number(t.duration) || DEFAULT_DAYS); t.correction = Number(t.correction) || 0; });

  let changed = true;
  let passes = 0;
  const maxPasses = tasks.length + 8;

  while(changed && passes < maxPasses){
    changed = false;
    passes++;

    for(const t of tasks){
      // skip if approval == "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ": locked ‚Äî we DO NOT change its start/end automatically while waiting
      if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ") {
        // But still ensure duration matches start/end if both exist
        if(t.start && t.end){
          const s = parseYMD(t.start), e = parseYMD(t.end);
          const dur = businessDaysBetweenInclusive(s,e);
          if(t.duration !== dur){ t.duration = dur; changed = true; }
        }
        continue;
      }

      // If depends exists and predecessor present and override false => start = pred.end (same day)
      if(t.depends && !t.override){
        const pred = lookup[t.depends];
        if(pred && pred.end){
          const predEnd = parseYMD(pred.end);
          if(predEnd){
            const desiredStart = fmtYMD(predEnd); // same day as pred end
            if(t.start !== desiredStart){
              t.start = desiredStart;
              changed = true;
            }
            // compute desired end based on duration (and correction if approval == '–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É')
            const baseEnd = addBusinessDays(parseYMD(t.start), t.duration - 1);
            let desiredEnd = baseEnd;
            if(t.approval === "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É"){
              // apply correction (could be negative)
              desiredEnd = addBusinessDays(desiredEnd, t.correction);
            }
            const desiredEndStr = fmtYMD(desiredEnd);
            if(t.end !== desiredEndStr){
              t.end = desiredEndStr;
              changed = true;
            }
            // update duration to actual (variant C): duration = businessDaysBetweenInclusive(start,end)
            const newDur = businessDaysBetweenInclusive(parseYMD(t.start), parseYMD(t.end));
            if(t.duration !== newDur){
              t.duration = newDur;
              // don't mark changed for duration-only change to avoid loops; but it's OK to mark
            }
          }
        }
      } else {
        // No depends or override true: if start exists -> ensure end matches duration, apply correction if status "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É"
        if(t.start){
          const s = parseYMD(t.start);
          if(s){
            let desiredEnd = addBusinessDays(s, t.duration - 1);
            if(t.approval === "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É"){
              desiredEnd = addBusinessDays(desiredEnd, t.correction);
            }
            const desiredEndStr = fmtYMD(desiredEnd);
            if(t.end !== desiredEndStr){
              t.end = desiredEndStr;
              changed = true;
            }
            // align duration to actual difference (C)
            const newDur = businessDaysBetweenInclusive(parseYMD(t.start), parseYMD(t.end));
            if(t.duration !== newDur){
              t.duration = newDur;
            }
          }
        } else if(t.end){
          // end exists but no start -> derive start from duration
          const e = parseYMD(t.end);
          if(e){
            const desiredStart = fmtYMD(addBusinessDays(e, - (t.duration - 1)));
            if(t.start !== desiredStart){
              t.start = desiredStart;
              changed = true;
            }
          }
        }
      }
    } // for tasks
  } // while

  // final normalization
  tasks.forEach(t=>{
    t.start = parseYMD(t.start) ? fmtYMD(parseYMD(t.start)) : "";
    t.end = parseYMD(t.end) ? fmtYMD(parseYMD(t.end)) : "";
    t.duration = Math.max(1, Number(t.duration) || DEFAULT_DAYS);
    t.correction = Number(t.correction) || 0;
  });
}

/* =========================
   UI render & bindings
   ========================= */
function render(){
  resolveAll();
  const tbody = document.querySelector("#tasksTable tbody");
  tbody.innerHTML = "";
  for(const t of tasks){
    const tr = document.createElement("tr");

    // ID
    const tdId = document.createElement("td"); tdId.className="id"; tdId.textContent = t.id; tr.appendChild(tdId);

    // name
    const tdName = document.createElement("td");
    const inName = document.createElement("input"); inName.type="text"; inName.value = t.name;
    inName.onchange = ()=>{ t.name = inName.value.trim(); save(); };
    tdName.appendChild(inName); tr.appendChild(tdName);

    // start
    const tdStart = document.createElement("td");
    const inStart = document.createElement("input"); inStart.type="date"; inStart.value = t.start || "";
    // if approval==–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ => disable editing
    if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ") inStart.disabled = true;
    inStart.onchange = ()=>{ if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ"){ alert("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –¥–∞—Ç—É –≤–æ –≤—Ä–µ–º—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è."); inStart.value = t.start; return; } t.start = inStart.value || ""; t.override = true; // manual edit enables override
      // recalc duration if end exists
      if(t.start && t.end){ const s=parseYMD(t.start), e=parseYMD(t.end); if(s && e) t.duration = businessDaysBetweenInclusive(s,e); }
      save();
    };
    tdStart.appendChild(inStart); tr.appendChild(tdStart);

    // end
    const tdEnd = document.createElement("td");
    const inEnd = document.createElement("input"); inEnd.type="date"; inEnd.value = t.end || "";
    if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ") inEnd.disabled = true;
    inEnd.onchange = ()=>{ if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ"){ alert("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –¥–∞—Ç—É –≤–æ –≤—Ä–µ–º—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è."); inEnd.value = t.end; return; } t.end = inEnd.value || ""; t.override = true; if(t.start && t.end){ const s=parseYMD(t.start), e=parseYMD(t.end); if(s && e) t.duration = businessDaysBetweenInclusive(s,e); } save(); };
    tdEnd.appendChild(inEnd); tr.appendChild(tdEnd);

    // duration
    const tdDur = document.createElement("td");
    const inDur = document.createElement("input"); inDur.type="number"; inDur.min=1; inDur.value = t.duration || DEFAULT_DAYS; inDur.style.width="92px";
    inDur.onchange = ()=>{ t.duration = Math.max(1, Number(inDur.value) || DEFAULT_DAYS); // if start exists and not override -> update end accordingly
      if(t.start && !t.override && t.approval !== "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ"){
        const s = parseYMD(t.start);
        t.end = fmtYMD(addBusinessDays(s, t.duration - 1));
      }
      save();
    };
    tdDur.appendChild(inDur); tr.appendChild(tdDur);

    // depends
    const tdDep = document.createElement("td");
    const inDep = document.createElement("input"); inDep.type="text"; inDep.value = t.depends || ""; inDep.placeholder = "A1 or exact name";
    inDep.onchange = ()=>{ t.depends = inDep.value.trim(); save(); };
    tdDep.appendChild(inDep); tr.appendChild(tdDep);

    // override
    const tdOv = document.createElement("td"); tdOv.className="center";
    const chk = document.createElement("input"); chk.type="checkbox"; chk.checked = !!t.override;
    chk.onchange = ()=>{ t.override = chk.checked; save(); };
    tdOv.appendChild(chk); tr.appendChild(tdOv);

    // approval
    const tdAp = document.createElement("td");
    const selAp = document.createElement("select");
    ["–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è","–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ","–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ","–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É"].forEach(opt=>{
      const o=document.createElement("option"); o.value=o.textContent=opt; if(t.approval===opt) o.selected=true; selAp.appendChild(o);
    });
    selAp.onchange = ()=>{ t.approval = selAp.value; // if entering "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ" -> lock dates
      if(t.approval === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ"){ /* do nothing else */ }
      // if switching to "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É" ensure correction field available (kept in model)
      save();
    };
    tdAp.appendChild(selAp); tr.appendChild(tdAp);

    // correction
    const tdCorr = document.createElement("td");
    const inCorr = document.createElement("input"); inCorr.type="number"; inCorr.style.width="90px"; inCorr.value = t.correction || 0;
    // only meaningful when approval == "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É"
    inCorr.disabled = (t.approval !== "–ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É");
    inCorr.onchange = ()=>{ t.correction = Number(inCorr.value) || 0; // after changing correction, recompute end = start + duration-1 + correction (business)
      if(t.start){
        const s = parseYMD(t.start);
        t.end = fmtYMD(addBusinessDays(addBusinessDays(s, t.duration - 1), t.correction));
        t.duration = businessDaysBetweenInclusive(parseYMD(t.start), parseYMD(t.end));
      }
      save();
    };
    tdCorr.appendChild(inCorr); tr.appendChild(tdCorr);

    // priority
    const tdPr = document.createElement("td");
    const selPr = document.createElement("select");
    [["–í—ã—Å–æ–∫–∏–π","üî• –í—ã—Å–æ–∫–∏–π"],["–°—Ä–µ–¥–Ω–∏–π","‚ö†Ô∏è –°—Ä–µ–¥–Ω–∏–π"],["–ù–∏–∑–∫–∏–π","‚úÖ –ù–∏–∑–∫–∏–π"]].forEach(([val,lab])=>{
      const o=document.createElement("option"); o.value=val; o.textContent=lab; if(t.priority===val) o.selected=true; selPr.appendChild(o);
    });
    selPr.onchange = ()=>{ t.priority = selPr.value; save(); };
    tdPr.appendChild(selPr); tr.appendChild(tdPr);

    // owner
    const tdOwn = document.createElement("td");
    const inOwn = document.createElement("input"); inOwn.type="text"; inOwn.value = t.owner || "";
    inOwn.onchange = ()=>{ t.owner = inOwn.value; save(); };
    tdOwn.appendChild(inOwn); tr.appendChild(tdOwn);

    // status
    const tdSt = document.createElement("td");
    const selSt = document.createElement("select");
    ["–ù–µ –Ω–∞—á–∞—Ç–æ","–í —Ä–∞–±–æ—Ç–µ","–û–∂–∏–¥–∞–Ω–∏–µ","–ì–æ—Ç–æ–≤–æ","–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ"].forEach(s=>{
      const o=document.createElement("option"); o.value=o.textContent=s; if(t.status===s) o.selected=true; selSt.appendChild(o);
    });
    selSt.onchange = ()=>{ t.status = selSt.value; save(); };
    tdSt.appendChild(selSt); tr.appendChild(tdSt);

    // actions
    const tdAct = document.createElement("td"); tdAct.className="center";
    const btnUp = document.createElement("button"); btnUp.className="ghost"; btnUp.style.padding="6px 8px"; btnUp.textContent="‚Üë"; btnUp.onclick = ()=>{ moveTask(t.id, -1); };
    const btnDown = document.createElement("button"); btnDown.className="ghost"; btnDown.style.padding="6px 8px"; btnDown.textContent="‚Üì"; btnDown.onclick = ()=>{ moveTask(t.id, 1); };
    const btnDel = document.createElement("button"); btnDel.style.marginLeft="6px"; btnDel.textContent="–£–¥–∞–ª–∏—Ç—å"; btnDel.onclick = ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å '+t.id+'?')) removeTask(t.id); };
    tdAct.appendChild(btnUp); tdAct.appendChild(btnDown); tdAct.appendChild(btnDel);
    tr.appendChild(tdAct);

    tbody.appendChild(tr);
  }

  // persist title
  const st = localStorage.getItem("project.title");
  if(st) document.getElementById("projectTitle").value = st;
  drawGantt();
}

/* CRUD helpers */
function genId(){
  let n=1; while(tasks.some(t=> t.id===`A${n}`)) n++; return `A${n}`;
}
function addTask(){
  const name = document.getElementById("taskName").value.trim();
  if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏"); return; }
  const start = document.getElementById("taskStart").value || "";
  const end = document.getElementById("taskEnd").value || "";
  const dur = Number(document.getElementById("taskDuration").value) || DEFAULT_DAYS;
  const depends = document.getElementById("taskDepends").value.trim() || "";
  const approval = document.getElementById("taskApproval").value;
  const correction = Number(document.getElementById("taskCorrection").value) || 0;
  const priority = document.getElementById("taskPriority").value;
  const owner = document.getElementById("taskOwner").value.trim() || "";
  const status = document.getElementById("taskStatus").value;

  const obj = { id: genId(), name, start, end, duration: Math.max(1,dur), depends, override:false, approval, correction, priority, owner, status };
  // derive end/start if only one present
  if(obj.start && !obj.end){ obj.end = fmtYMD(addBusinessDays(parseYMD(obj.start), obj.duration - 1)); }
  if(obj.end && !obj.start){ obj.start = fmtYMD(addBusinessDays(parseYMD(obj.end), - (obj.duration - 1))); }
  tasks.push(obj);
  // clear inputs
  document.getElementById("taskName").value=""; document.getElementById("taskStart").value=""; document.getElementById("taskEnd").value="";
  document.getElementById("taskDuration").value=""; document.getElementById("taskDepends").value=""; document.getElementById("taskCorrection").value="";
  document.getElementById("taskOwner").value="";
  save();
}
function removeTask(id){
  tasks = tasks.filter(t=> t.id !== id); tasks.forEach(t=> { if(t.depends === id) t.depends = ""; });
  save();
}
function moveTask(id, dir){
  const idx = tasks.findIndex(t=> t.id===id); if(idx<0) return; const to = idx + dir; if(to<0||to>=tasks.length) return; const tmp = tasks[to]; tasks[to]=tasks[idx]; tasks[idx]=tmp; save();
}
function clearAll(){ if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ?")){ tasks=[]; save(); } }

/* CSV export/import */
function downloadCSV(){
  const hdr = ["ID","Name","Start","End","Duration","Depends","Override","Approval","Correction","Priority","Owner","Status"];
  const rows = tasks.map(t => [t.id, `"${(t.name||"").replace(/"/g,'""')}"`, t.start||"", t.end||"", String(t.duration||""), `"${(t.depends||"").replace(/"/g,'""')}"`, t.override?"1":"0", t.approval||"", String(t.correction||"0"), t.priority||"", t.owner||"", t.status||""]);
  const txt = [hdr.join(","), ...rows.map(r=> r.join(","))].join("\n");
  const blob = new Blob([txt], {type:"text/csv;charset=utf-8"}); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="tasks.csv"; a.click(); URL.revokeObjectURL(url);
}
function importCSVPrompt(){
  const inp = document.createElement("input"); inp.type="file"; inp.accept=".csv"; inp.onchange = e=>{ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ parseCSV(ev.target.result); save(); } catch(err){ alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: "+err); } }; r.readAsText(f,"utf-8"); }; inp.click();
}
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(Boolean); if(lines.length<2) throw "CSV –ø—É—Å—Ç";
  const newTasks = [];
  for(let i=1;i<lines.length;i++){
    const cols = csvSplit(lines[i]);
    const t = {
      id: cols[0] || genId(),
      name: cols[1] ? cols[1].replace(/^"|"$/g,"").replace(/""/g,'"') : "",
      start: cols[2]||"",
      end: cols[3]||"",
      duration: Number(cols[4]) || DEFAULT_DAYS,
      depends: cols[5] ? cols[5].replace(/^"|"$/g,"").replace(/""/g,'"') : "",
      override: (cols[6]||"") === "1",
      approval: cols[7] || "–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è",
      correction: Number(cols[8]) || 0,
      priority: cols[9] || "–°—Ä–µ–¥–Ω–∏–π",
      owner: cols[10] || "",
      status: cols[11] || "–ù–µ –Ω–∞—á–∞—Ç–æ"
    };
    newTasks.push(t);
  }
  tasks = newTasks;
}
function csvSplit(line){
  const out=[]; let cur=""; let q=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch === '"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; continue; }
    if(ch === ',' && !q){ out.push(cur); cur=""; continue; }
    cur += ch;
  }
  out.push(cur);
  return out;
}

/* =========================
   Gantt drawing
   ========================= */
function drawGantt(){
  resolveAll();
  const canvas = document.getElementById("ganttCanvas");
  const ctx = canvas.getContext("2d");
  const containerWidth = canvas.clientWidth;
  canvas.width = Math.max(700, Math.floor(containerWidth));
  const width = canvas.width, height = canvas.height = 460;
  ctx.clearRect(0,0,width,height);

  const valid = tasks.filter(t => parseYMD(t.start) && parseYMD(t.end));
  if(valid.length === 0){
    ctx.fillStyle = "#666"; ctx.font = "14px Arial"; ctx.fillText("–ù–µ—Ç –∑–∞–¥–∞—á —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏ –¥–ª—è –ì–∞–Ω—Ç–∞", 20, 24); return;
  }

  // compute global min/max
  let min = parseYMD(valid[0].start), max = parseYMD(valid[0].end);
  valid.forEach(t => { const s=parseYMD(t.start), e=parseYMD(t.end); if(s && s < min) min = s; if(e && e > max) max = e; });
  min = addBusinessDays(min, -1); max = addBusinessDays(max, 1);
  const totalDays = businessDaysBetweenInclusive(min, max);
  const leftPad = 160, rightPad = 40;
  const usable = width - leftPad - rightPad;
  const pxPerDay = Math.max(6, usable / Math.max(1, totalDays));

  // header background
  ctx.fillStyle = "#fafbff"; ctx.fillRect(leftPad, 0, usable, 28);
  ctx.font = "12px Arial";
  // draw grid and date labels (iterate real calendar days but place only business days)
  let dayIndex = 0;
  for(let d=0; d<3650; d++){ // safety limit
    const cur = addDaysUTC(min, d);
    if(cur > max) break;
    if(isWeekend(cur)) continue;
    const x = leftPad + Math.round(dayIndex * pxPerDay);
    ctx.strokeStyle = "#f0f2f7"; ctx.beginPath(); ctx.moveTo(x+0.5, 28); ctx.lineTo(x+0.5, height - 16); ctx.stroke();
    if(pxPerDay > 14 || dayIndex % Math.max(1, Math.ceil(3 / (pxPerDay/8))) === 0){
      ctx.fillStyle = "#333";
      ctx.fillText(fmtYMD(cur), x+2, 18);
    }
    dayIndex++;
  }

  // draw rows
  const rowH = 38;
  valid.forEach((t, idx) => {
    const y = 36 + idx * rowH;
    ctx.fillStyle = "#111"; ctx.font = "13px Arial"; ctx.fillText(`${t.id} ${t.name}`, 10, y + 16);
    ctx.fillStyle = idx%2===0 ? "#fff" : "#fbfcff"; ctx.fillRect(leftPad, y, usable, rowH - 6);

    const s = parseYMD(t.start), e = parseYMD(t.end);
    if(!s || !e) return;
    // compute day offset among business days from min
    let offset = 0, cum = 0;
    for(let d=0;;d++){
      const cur = addDaysUTC(min, d);
      if(cur > s) break;
      if(!isWeekend(cur)){
        if(cur < s) cum++;
        else if(fmtYMD(cur) === fmtYMD(s)) { /* s matches this business day */ }
      }
      if(cur >= s) break;
    }
    // simpler: compute businessDays between min and s, exclusive of min? we'll compute incrementally:
    offset = 0; let cur = new Date(min.getTime());
    while(cur < s){
      if(!isWeekend(cur)) offset++;
      cur = addDaysUTC(cur,1);
    }
    const dur = businessDaysBetweenInclusive(s,e);
    const x = leftPad + Math.round(offset * pxPerDay);
    const w = Math.max(6, Math.round(dur * pxPerDay));

    let color = "#4666ff";
    if(t.status === "–ì–æ—Ç–æ–≤–æ") color = "#2db47e";
    if(t.status === "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ") color = "#ff6b6b";

    // draw bar
    ctx.fillStyle = color;
    roundRect(ctx, x+2, y+6, w-4, 24, 6, true, false);

    ctx.fillStyle = "#fff"; ctx.font = "12px Arial";
    if(w > 80) ctx.fillText(t.name, x + 10, y + 22);
    else { ctx.fillStyle = "#333"; ctx.fillText(t.name, x + w + 8, y + 21); }

    // draw small start/end
    ctx.fillStyle = "#666"; ctx.font = "11px Arial";
    ctx.fillText(fmtYMD(s), x, y + 36);
    ctx.fillText(fmtYMD(e), x + Math.max(6, w - 60), y + 36);
  });

  ctx.strokeStyle = "#e9eefb";
  ctx.strokeRect(leftPad, 28, usable, valid.length * rowH);

  function roundRect(ctx,x,y,w,h,r,fill,stroke){
    if(w < 2*r) r = w/2; if(h < 2*r) r = h/2;
    ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
    if(fill) ctx.fill(); if(stroke) ctx.stroke();
  }
}

/* =========================
   Init boot
   ========================= */
document.getElementById("projectTitle").addEventListener("change", ()=> localStorage.setItem("project.title", document.getElementById("projectTitle").value));
function boot(){ const t = localStorage.getItem("project.title"); if(t) document.getElementById("projectTitle").value = t; load(); render(); window.addEventListener("resize", ()=> drawGantt()); window.tracker = { tasks, save, load, render, drawGantt, resolveAll }; }
boot();

</script>
</body>
</html>
